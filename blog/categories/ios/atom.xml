<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: iOS | Artsy Engineering]]></title>
  <link href="http://artsy.github.io/blog/categories/ios/atom.xml" rel="self"/>
  <link href="http://artsy.github.io/"/>
  <updated>2014-08-04T20:22:20+02:00</updated>
  <id>http://artsy.github.io/</id>
  <author>
    <name><![CDATA[Artsy]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Aspect-Oriented Programming and ARAnalytics]]></title>
    <link href="http://artsy.github.io/blog/2014/08/04/aspect-oriented-programming-and-aranalytics/"/>
    <updated>2014-08-04T14:52:00+02:00</updated>
    <id>http://artsy.github.io/blog/2014/08/04/aspect-oriented-programming-and-aranalytics</id>
    <content type="html"><![CDATA[<p>Analytics are common in iOS applications. They help inform our decisions
about products. Since analytics are so common, Artsy developed a library called
<a href="https://github.com/orta/ARAnalytics">ARAnalytics</a>. This library provides a
single interface to many different backend analytics providers, freeing
developers from having to write code for each of the providers that they're
using.</p>

<p>Let's consider a typical view controller on iOS. View controllers on iOS
represent the glue code between models and views. When a model changes, the view
controller updates the appearance of the UI. Similarly, when the UI is
interacted with by the user, the view controller updates the model. This is the
core of any standard iOS application.</p>

<p>So let's say that a button is pressed. We'll handle that interaction in a
method called <code>buttonWasPressed:</code>. We'll want to update our model, but also to
track the analytics event.</p>

<p>``` objc
- (void)buttonWasPressed:(id)sender
{
    self.model.hearted = YES;</p>

<pre><code>[ARAnalytics event:@"hearted"];
</code></pre>

<p>}
```</p>

<p>Simple enough, but consider that the analytics tracking code doesn't fall within
our definition of a view controller – the button handler just happens to be a
convenient place to put the tracking code. Also consider that <em>every single</em>
button handler is going to have to have similar code implemented.</p>

<h2>There has to be a better way.</h2>

<!-- more -->


<p><a href="http://twitter.com/steipete">Pete Steinberger</a> and <a href="http://twitter.com/orta">Orta Therox</a>
were talking and the topic of <a href="http://en.wikipedia.org/wiki/Aspect-oriented_programming">Aspect-Oriented Programming</a>,
specifically in the context of analytics. AOP takes a look at the different
<em>conerns</em> of an application – logical, cohesive units of functionality. While
most programming paradigms, including those used with Objective-C, group and
encapsulate these concerns, there are some concerns that are "cross-cutting"
because they are involved through several other concerns.</p>

<p>Analytics is such a cross-cutting concern. That makes it a prime target for
being abstracted away using AOP. Using <a href="http://albertodebortoli.github.io/blog/2014/03/25/an-aspect-oriented-approach-programming-to-ios-analytics/">another blog post</a>  as an example, we set about <a href="https://github.com/orta/ARAnalytics/pull/74">integrating an AOP-like DSL within ARAnalytics</a>
that would allow you to define all of your analytics in one spot.</p>

<p>The interface would be simple. When providing your API keys to the various
backend services you'd like to use with ARAnalytics, you'd also provide a
dictionary specifying the classes you'd like us to "hook into". Whenever a
selector from an instance of the given class was invoked, we'd execute the
analytics event specified in the dictionary.</p>

<p>Since Objective-C has a dynamic runtime, we could have swizzled the instance
methods on the classes you specified in the dictionary. This gets a little
tricky and represents a lot of work for us. We could directly swizzle the
instance methods on the classes in question, but wrapping parameters of variable
types and in various numbers becomes a chore. If we didn't get it done
perfectly, we'd risk introducing bugs into the entire application.</p>

<p>I wrote a proof-of-concept of analytics using AOP with <a href="http://reactivecocoa.io">ReactiveCocoa</a>.
It worked, but was a little hacky since it involved the swizzling of <code>alloc</code>.
ReactiveCocoa is also a large framework to be included just for the sake of
analytics. Additionally, its interface exposed ReactiveCocoa's <code>RACTuple</code> class,
which smells like a leaky abstraction.</p>

<h2>What could we do?</h2>

<p>Well, about the same time, Pete Steinberger open sourced a new framework just
for AOP called <a href="https://github.com/steipete/Aspects">Aspects</a>. Pete did all the
difficult work of swizzling methods with variable parameter lists, including
wrapping primitive parameters in values.</p>

<p>Pete and I worked together to get Aspects working with ARAnalytics, removing our
dependency on ReactiveCocoa.</p>

<h2>How to Use it</h2>

<p>Using ARAnalytics with the new DSL is super-easy. Just add either <code>ARAnalytics</code>
or <code>ARAnalytics/DSL</code> to your podfile, specifying a version of at least 2.6. Run
<code>pod install</code> and you're ready to get started.</p>

<p>Since all of your analytics are going to be specified in one spot, and that spot
is going to get rather large, I'd recommend creating an Objective-C category on
your app delegate to set up all of your analytics. Then you can call this
<code>setupAnalytics</code> method when your app launches.</p>

<p>``` objc</p>

<h1>import "ARAppDelegate.h"</h1>

<p>@interface ARAppDelegate (Analytics)</p>

<ul>
<li>(void)setupAnalytics;</li>
</ul>


<p>@end</p>

<pre><code>
``` objc


#import &lt;ARAnalytics/DSL.h&gt;

@implementation ARAppDelegate (Analytics)

- (void)setupAnalytics 
{
    [ARAnalytics setupWithAnalytics:@{
        /* keys */
    } configuration:
    @{
        ARAnalyticsTrackedEvents: @[
            @{
                ARAnalyticsClass: MyViewController.class,
                ARAnalyticsDetails: @[
                    @{
                        ARAnalyticsEventName: @"hearted",
                        ARAnalyticsSelectorName: NSStringFromSelector(@selector(buttonWasPressed:)),
                    }
                ]
            }
        ]
    }];
}

@end
</code></pre>

<p>Now our <code>buttonWasPressed:</code> method is <em>very</em> straightforward:</p>

<p><code>objc
- (void)buttonWasPressed:(id)sender
{
    self.model.hearted = YES;
}
</code></p>

<p>The view controller is now <em>only</em> responsible for what it should be responsible
for: mediating interactions between the view and the model. Awesome! Even
cooler, we can provide fine-grain control over which analytics events are
invoked and with what properties they are sent with. Let's take a look.</p>

<p>``` objc
[ARAnalytics setupWithAnalytics:@{
    /<em> keys </em>/
} configuration:
@{
    ARAnalyticsTrackedEvents: @[
        @{
            ARAnalyticsClass: MyViewController.class,
            ARAnalyticsDetails: @[
                @{
                    ARAnalyticsEventName: @"hearted",
                    ARAnalyticsSelectorName: NSStringFromSelector(@selector(buttonWasPressed:)),
                    ARAnalyticsEventProperties: ^NSDictionary <em>(MyViewController </em>controller, NSArray <em>parameters) {
                        UIButton </em>button = parameters.firstObject;
                        NSString <em>buttonTitle = [button titleForState:UIControlStateNormal];
                        return @{
                            @"view_title" : controller.title ?: @"",
                            @"button_title" : buttonTitle ?: @"",
                        };
                    },
                    ARAnalyticsShouldFire: ^BOOL(MyViewController </em>controller, NSArray <em>parameters) {
                        return /</em> selective disable firing of analytics */;
                    }
                }
            ]
        }
    ]
}];</p>

<p>@end</p>

<pre><code>
So you see that even though you're defining your analytics once, at application
startup, you're still able to provide dynamic, per-instance behaviour and event
properties. 

Finally, we've also written support for page views. In a few lines, you can
have every view controller track its page view with ARAnalytics. 

``` objc
[ARAnalytics setupWithAnalytics:@{
    /* keys */
} configuration:
@{
    ARAnalyticsTrackedScreens: @[
        @{
            ARAnalyticsClass: UIViewController.class,
            ARAnalyticsDetails: @[ // default selector on iOS is viewDidAppear:
                @{
                    ARAnalyticsPageNameKeyPath: @"title"
                }
            ]
        }
    ]
}];

@end
</code></pre>

<p>This code will track a page view with the title the same as the view
controller's <code>title</code> property, but just like with events you can provide
fine-grained handling.</p>

<h2>Some Limitations</h2>

<p>There is a <a href="https://github.com/steipete/Aspects/issues/11">limitation</a> on
Aspects that wasn't fully understood until we used the new AOP approach to
analytics in the Artsy app. Selectors can only be "hooked into" once per class
hierarchy. That  means that you cannot create a tracked events for two
difference view controllers, both on the <code>viewWillAppear:</code> selector. This is a
temporary limitation while the Aspects library is being worked on. In the mean
time, you are free to use the <a href="https://github.com/orta/ARAnalytics/tree/ashfurrow-temporary-dsl-fix">original implementation</a>
with ReactiveCocoa, which doesn't have this limitation and which we are using
currently.</p>

<h2>What we Learnt</h2>

<p>AOP is a really cool paradigm that can reduce tight coupling in your code and
increase your overall level of cohesion. Its applications extend beyond just
analytics – any time you have a behaviour that's being exhibited in several
abstractions in your code, you should consider if using AOP to replace that
behaviour might make for cleaner code and more cohesive abstractions.</p>

<p>Finally, I got to make my first significant contribution to open source at
Artsy. It was awesome to be able to collaborate with Pete and Orta on this
project, as well as receive feedback from developers who are already using
ARAnalytics.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ARAnalytics - Analytics for iOS Apps]]></title>
    <link href="http://artsy.github.io/blog/2013/04/10/aranalytics/"/>
    <updated>2013-04-10T17:23:00+02:00</updated>
    <id>http://artsy.github.io/blog/2013/04/10/aranalytics</id>
    <content type="html"><![CDATA[<p>In both my <a href="http://orta.github.com">personal apps</a> and Artsy Folio, I'm always after a deeper understanding of how people use the app. There's three ways to do this: ask users, watch users and track usage. I'd like to talk about the third of these.</p>

<p>We've experimented with quite a lot of analytics tools for the Artsy website, and it seemed fitting to do the same for our mobile app. We wanted the freedom to change the analytics tool without having to change the code, and so <a href="http://github.com/orta/ARAnalytics">ARAnalytics</a> was born.</p>

<!-- more -->


<p>ARAnalytics is the adaption of <a href="https://github.com/jkrall/analytical">Analytical</a> and  <a href="http://segmentio.github.com/analytics.js/">Analytics.js</a> to iOS. By using <a href="http://cocoapods.org">Cocoapods</a> it became possible to set up the entire analytics stack with only a few lines of code in your <code>Podfile</code>.</p>

<p><code>ruby
  pod "ARAnalytics/Crashlytics"
  pod "ARAnalytics/Mixpanel"
</code></p>

<p>The list of supported libraries is pretty vast ( <em>TestFlight, Mixpanel, Localytics, Flurry, Google Analytics, KISSMetrics, Countly, Crittercism, Bugsnag and Crashlytics</em> ) and the API for <code>ARAnalytics</code> tries to bridge any gaps it can find in the implementations.</p>

<p><code>ARAnalytics</code> simplifies the API to two main parts of tracking; user details and events. User details are things like your internal ID for a user, and custom properties like your app's preferences, whilst events are temporal actions that are triggered based off user actions.</p>

<p>There is another tool worth mentioning and that is <a href="http://cocoadocs.org/dosets/Analytics/0.0.5/">Analytics</a> which is a new port of Analytics.js which does a similar <em>simple API to different analytics providers</em> but works by offloading the work to the server. I think there are advantages and disadvantages to both of these approaches, but I think one or the other should cover nearly all use cases!</p>

<p>ARAnalytics is available on Github at <a href="http://github.com/orta/ARAnalytics">orta/ARAnalytics</a> and documented on <a href="http://cocoadocs.org/docsets/ARAnalytics/1.2/">Cocoadocs</a> (which Artsy proudly sponsors!)</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Musical Chairs]]></title>
    <link href="http://artsy.github.io/blog/2013/03/29/musical-chairs/"/>
    <updated>2013-03-29T16:38:00+01:00</updated>
    <id>http://artsy.github.io/blog/2013/03/29/musical-chairs</id>
    <content type="html"><![CDATA[<p> At Artsy we make Artsy Folio. Folio is an awesome portfolio app that shows our gallery and museum partners their artworks in one place, allows them to easily get information about their inventory and to send works by email to their contacts.</p>

<p>Folio has to deal with large multi-gigabyte syncs in order to operate offline. That makes for a great user experience, but for the developer working on the sync, it's not as pleasant. Combined with our use of Core Data, the app’s maturity, and dealing with data store migrations, things can get hairy. We needed a tool that could freeze and restore app data at will, obviating the need for constant syncing and resyncing.</p>

<p>That's why I built <a href="https://github.com/orta/chairs">chairs</a>...</p>

<!--more-->


<p>Chairs is a gem you can install via <code>gem install chairs</code>. It allows you to stash and replace your current iOS simulator application state. It will grab everything related to the app ( including the current <code>NSUserDefaults</code>) and store it in a named subfolder in your current working directory. No black magic, just lots of copying files.</p>

<p>The command line interface is based on git, so to bring in the current state you run <code>chairs pull [name]</code> and to replace the state you use <code>chairs push [name]</code>. The name is just a label so you can remember which version corresponds to that musical chair. You can get a list of these by doing <code>chairs list</code>, and delete them with <code>chairs rm [name]</code>.</p>

<p>Besides the core functionality, chairs has a little bit of sugar to help you with related tasks. My personal favourite is <code>chairs open</code>; this will just open the folder of the most recently used app so you can go and have a snoop around. Amazing for making sure files are where they say they are or for opening your sqlite database in <a href="http://menial.co.uk/base/">Base</a>.</p>

<p>So <code>gem install chairs</code> or check out the <a href="https://github.com/orta/chairs">README</a> for some more information.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The perils of iOS user agent strings]]></title>
    <link href="http://artsy.github.io/blog/2012/10/18/the-perils-of-ios-user-agent-sniffing/"/>
    <updated>2012-10-18T15:19:00+02:00</updated>
    <id>http://artsy.github.io/blog/2012/10/18/the-perils-of-ios-user-agent-sniffing</id>
    <content type="html"><![CDATA[<p>There is a great deal of misinformation on the web about detecting an
iPad or an iPhone in JavaScript. The
<a href="http://stackoverflow.com/a/4617648">top answer on stackoverflow</a> -
and many <a href="http://www.sitepoint.com/identify-apple-iphone-ipod-ipad-visitors/">blog posts</a> using <a href="http://www.askdavetaylor.com/detect_apple_iphone_user_web_site_server.html">this technique</a> - are all incorrect.</p>

<p>The conventional wisdom is that iOS devices have a user agent for
Safari and a user agent for the UIWebView. This assumption is
incorrect as iOS apps can and do
<a href="http://stackoverflow.com/a/8666438">customize their user agent</a>. The
main offender here is Facebook, whose iOS app alone accounts for about
1-3% of Artsy's daily traffic.</p>

<p>Compare these user agent strings from iOS devices:
```</p>

<h1>iOS Safari</h1>

<p>iPad: Mozilla/5.0 (iPad; CPU OS 5_1 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Version/5.1 Mobile/9B176 Safari/7534.48.3
iPhone: Mozilla/5.0 (iPhone; CPU iPhone OS 5_0 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Version/5.1 Mobile/9A334 Safari/7534.48.3</p>

<h1>UIWebView</h1>

<p>iPad: Mozilla/5.0 (iPad; CPU OS 5_1 like Mac OS X) AppleWebKit/534.46 (KHTML, like Gecko) Mobile/98176
iPhone: Mozilla/5.0 (iPhone; U; CPU iPhone OS 4_1 like Mac OS X; en-us) AppleWebKit/532.9 (KHTML, like Gecko) Mobile/8B117</p>

<h1>Facebook UIWebView</h1>

<p>iPad: Mozilla/5.0 (iPad; U; CPU iPhone OS 5_1_1 like Mac OS X; en_US) AppleWebKit (KHTML, like Gecko) Mobile [FBAN/FBForIPhone;FBAV/4.1.1;FBBV/4110.0;FBDV/iPad2,1;FBMD/iPad;FBSN/iPhone OS;FBSV/5.1.1;FBSS/1; FBCR/;FBID/tablet;FBLC/en_US;FBSF/1.0]
iPhone: Mozilla/5.0 (iPhone; U; CPU iPhone OS 5_1_1 like Mac OS X; ru_RU) AppleWebKit (KHTML, like Gecko) Mobile [FBAN/FBForIPhone;FBAV/4.1;FBBV/4100.0;FBDV/iPhone3,1;FBMD/iPhone;FBSN/iPhone OS;FBSV/5.1.1;FBSS/2; tablet;FBLC/en_US]
```</p>

<!-- more -->


<p>The old way to identify iPhone / iPad in JavaScript:
<code>javascript
IS_IPAD = navigator.userAgent.match(/iPad/i) != null;
IS_IPHONE = navigator.userAgent.match(/iPhone/i) != null) || (navigator.userAgent.match(/iPod/i) != null);
</code></p>

<p>If you were to go with this approach for detecting iPhone and iPad,
you would end up with IS_IPHONE <em>and</em> IS_IPAD both being true if a user
comes from Facebook on an iPad. That could create some odd behavior!</p>

<p>The correct way to identify iPhone / iPad in JavaScript:
<code>javascript
IS_IPAD = navigator.userAgent.match(/iPad/i) != null;
IS_IPHONE = (navigator.userAgent.match(/iPhone/i) != null) || (navigator.userAgent.match(/iPod/i) != null);
if (IS_IPAD) {
  IS_IPHONE = false;
}
</code></p>

<p>We simply declare <code>IS_IPHONE</code> to be <code>false</code> on iPads to cover for the
bizarre Facebook UIWebView iPad user agent. This is one example of how
<em>user agent sniffing is unreliable</em>. The more iOS apps that customize
their user agent, the more issues user agent sniffing will have. If
you can avoid user agent sniffing (hint: CSS Media Queries), DO
IT.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[On Grid Thumbnails]]></title>
    <link href="http://artsy.github.io/blog/2012/09/13/on-grid-thumbnails/"/>
    <updated>2012-09-13T16:40:00+02:00</updated>
    <id>http://artsy.github.io/blog/2012/09/13/on-grid-thumbnails</id>
    <content type="html"><![CDATA[<p><img src="http://artsy.github.io/images/2012-09-13-on-grid-thumbnails/grid.jpg"></p>

<p>Artsy Folio, our free iPad app for Gallery Partners, had been in the App Store for a couple of weeks before the iPad with a Retina display was announced. This had been something we expected internally and felt the application would be ready. We had all our image assets available in <em>@2x</em> versions and an image pipeline that would take scaling into account. With that in mind, we changed our artwork grid view to show a double resolution image. Finally, once we were happy that it worked fine on the simulator, we sent the build off to Apple for review.</p>

<p>The app passed review, and was Retina-ready before the actual release. But within hours of getting our hands on a real Retina iPad, we had to pull the app. This post will explain why, and what we did to work it out.</p>

<!--more-->


<p>Scrolling the grid view was slow. Extremely slow. The reason why wasn't obvious initially, but thanks to digging around using <a href="http://developer.apple.com/library/mac/#documentation/DeveloperTools/Conceptual/InstrumentsUserGuide/Introduction/Introduction.html">Instruments</a>, we saw that a great deal of time was spent in Apple's image processing libraries. This was a strong hint that the problem involved taking the file and getting it to the screen.</p>

<p>In our naiveté, Folio was originally using <code>UIImage</code>'s <code>initWithContentsOfFile:</code> to load (without caching) a jpg from the file system. Once the file was loaded into memory, we displayed it onscreen in an <code>UIImageView.</code> This was fast enough to deal with our small thumbnails of <em>240x240</em> but the moment that you start asking it to pull 3 or 4 <em>480x480</em> jpg files off the filesystem, decompress them and then put them on the screen, you're not going to have a smooth scroll.</p>

<p><img src="http://artsy.github.io/images/2012-09-13-on-grid-thumbnails/thumbnails.jpg"></p>

<p>As we knew that we were looking at an issue with getting images from a file, it made sense to start looking at ways to move image processing off the main thread. This Stack Overflow thread on <a href="http://stackoverflow.com/questions/1815476/cgimage-uiimage-lazily-loading-on-ui-thread-causes-stutter">UIImage lazy loading</a> proved to be an essential start to dealing with our issue. We needed a thread-safe way to get the contents of a file and to pass them through once the images had been decoded. What we needed was <a href="https://gist.github.com/3715588">initImmediateLoadWithContentsOfFile</a>, a thread-safe way to go from a filepath to a <code>UIImage</code>.</p>

<p>Now that we had a way to get an image that was safe to go on a background thread, we gave our grid an <code>NSOperationQueue</code> and created a method to kick off a <code>NSInvocationOperation</code> with our the cell we're looking at and the address it needs to load the thumbnail.</p>

<p>``` objc
- (void)setImageAsyncAtPath:(NSString <em>)imageAddress forGridCell:(ARImageGridViewCell </em>)cell {
    NSDictionary <em>operationOptions = @{@"address": imageAddress, @"cell": cell};
    NSInvocationOperation </em>operation = [[NSInvocationOperation alloc] initWithTarget:self selector:@selector(asyncLoadImage:) object:operationOptions];</p>

<pre><code>[_operationQueue addOperation:operation];
</code></pre>

<p>}
```</p>

<p>When we had the simplest implementation of <code>asyncLoadImage</code> we found that scrolling would sometimes result in grid cells displaying the wrong image. It turned out that in the time it took to decode the jpg,  the cell had already been reused for a different artwork. This one totally caught us off guard!</p>

<p>``` objc
- (void)asyncLoadImage:(NSDictionary <em>)options {
    @autoreleasepool {
        NSString </em>address = options[@"address"];
        ARImageGridViewCell *cell = options[@"cell"];</p>

<pre><code>    // don't load if it's on a different cell
    if ([cell.imagePath isEqualToString:address]) {
        UIImage *thumbnail = [[UIImage alloc] initImmediateLoadWithContentsOfFile:address];

        // double check that during the decoding the cell's not been re-used
        if ([cell.imagePath isEqualToString:address] &amp;&amp; thumbnail) {
            [cell performSelectorOnMainThread:@selector(setImage:) withObject:thumbnail waitUntilDone:NO];
        }
    }
}
</code></pre>

<p>}
```</p>

<p>This meant we could have our UI thread dealing with scrolling, whilst <a href="https://developer.apple.com/technologies/mac/core.html">Grand Central Dispatch</a> would deal with ensuring the image processing was done asynchronously and as fast as possible.However, this still wasn't enough. We were finding if you scrolled fast enough, you could still see images pop in after the grid cell was visible. For this, we actually went back to the beginning, and made our image pipeline create a <em>120x120</em> thumbnail for each artwork that we use <code>initImmediateLoadWithContentsOfFile</code> to load on the UI thread. This is fast enough to smoothly scroll, and is replaced by the higher resolution image practically instantly.</p>

<p><img src="http://artsy.github.io/images/2012-09-13-on-grid-thumbnails/hover-thumbnails.jpg"></p>

<p>The rest of the story is pretty straightforward. We wrapped all this up within a few days and got out a version of Folio for the Retina iPad, I ended up doing a talk about the issues involved in doing this in <a href="http://lsx.co/lsxcafe/">Leeds LSxCafé</a>, and you got a blog post out of it.</p>
]]></content>
  </entry>
  
</feed>
